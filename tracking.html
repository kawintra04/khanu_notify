<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ติดตามสถานะแจ้งปัญหา - Khanu School Notication</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- CDN Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- CDN FontAwesome Pro -->
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/fontawesome.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/whiteboard-semibold.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/thumbprint-light.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/slab-press-regular.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/slab-regular.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/sharp-duotone-thin.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/sharp-duotone-solid.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/sharp-duotone-regular.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/sharp-duotone-light.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/sharp-thin.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/sharp-solid.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/sharp-regular.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/sharp-light.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/notdog-duo-solid.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/notdog-solid.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/jelly-fill-regular.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/jelly-regular.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/etch-solid.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/duotone-thin.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/duotone.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/duotone-regular.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/duotone-light.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/thin.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/solid.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/regular.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/light.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/brands.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v7.0.0/css/chisel-regular.css">

    <link rel="stylesheet" href="style/styles.css">
    <link rel="icon" type="image/x-icon" href="asset/icons/logo_khanu512.png">
</head>

<body>
    <div id="loader-container"></div>

    <div class="main-container" style="display: none;">
        <div id="page-content4" class="p-3 h-100 pb-5 mb-5">
            <div class="mb-0">
                <span id="back-button" class="text-white" role="button" onclick="window.history.back();">
                    <i class="fa-solid fa-chevron-left fa-xl"></i>
                </span>
            </div>
            <div class="text-center text-white mb-3">
                <img src="asset/icons/logo_khanu512.png" alt="Khanu School Logo" class="mb-2"
                    style="width: 100px; height: 100px;">
                <h2 class="mb-0">ติดตามสถานะแจ้งปัญหา</h2>
                <p class="mb-0">โรงเรียนขาณุวิทยา
                <div role="button" data-bs-toggle="modal" data-bs-target="#infoModal">
                    <i class="fa-solid fa-circle-info text-white"></i>
                </div>
                </p>
            </div>

            <div class="container-fluid mb-3">
                <div class="row text-center g-3">
                    <div class="col-6">
                        <div class="card border-0 shadow rounded-4 p-3 bg-gradient-allissue">
                            <div class="row d-flex justify-content-center align-items-center mb-2">
                                <div class="col-4 fs-3 opacity-25">
                                    <i class="fa-solid fa-clipboard-list fa-2xl text-white-50"></i>
                                </div>
                                <div class="col d-flex align-items-center flex-column">
                                    <div class="fw-semibold fs-1" id="total-issues">0</div>
                                    <div class="font-size-14 text-white-50">เรื่องทั้งหมด</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card border-0 shadow rounded-4 p-3 bg-gradient-process">
                            <div class="row d-flex justify-content-center align-items-center mb-2">
                                <div class="col-4 fs-3 opacity-50">
                                    <i class="fa-solid fa-hammer-brush fa-2xl text-white-50"></i>
                                </div>
                                <div class="col d-flex align-items-center flex-column">
                                    <div class="fw-semibold fs-1" id="in-progress-issues">0</div>
                                    <div class="font-size-14 text-dark-50">ดำเนินการ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card border-0 shadow rounded-4 p-3 bg-gradient-success">
                            <div class="row d-flex justify-content-center align-items-center mb-2">
                                <div class="col-4 fs-3 opacity-50">
                                    <i class="fa-solid fa-thumbs-up fa-2xl text-white-50"></i>
                                </div>
                                <div class="col d-flex align-items-center flex-column">
                                    <div class="fw-semibold fs-1" id="completed-issues">0</div>
                                    <div class="font-size-14 text-white-50">เสร็จสิ้น</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card border-0 shadow rounded-4 p-3 bg-gradient-cencel">
                            <div class="row d-flex justify-content-center align-items-center mb-2">
                                <div class="col-4 fs-3 opacity-50">
                                    <i class="fa-solid fa-ban fa-2xl text-white-50"></i>
                                </div>
                                <div class="col d-flex align-items-center flex-column">
                                    <div class="fw-semibold fs-1" id="cancelled-issues">0</div>
                                    <div class="font-size-14 text-white-50">ยกเลิก</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid p-3 pb-5 bg-white rounded-4 shadow">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <span class="font-size-14 text-muted"><i class="fa-solid fa-window-restore"></i>
                        สถานะการแจ้งปัญหา</span>
                </div>

                <div id="issue-list" class="list-group">
                    <!-- รายการแจ้งปัญหาจะถูกเพิ่มที่นี่โดย JavaScript -->
                     <div class="text-center text-muted py-4">
                        <lord-icon
                            src="https://cdn.lordicon.com/msoeawqm.json"
                            trigger="loop"
                            colors="primary:#121331,secondary:#08a88a"
                            style="width:100px;height:100px">
                        </lord-icon>
                        <p class="mt-3 font-size-14">ไม่มีข้อมูลการแจ้งปัญหา</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="py-5 text-transparent">.</div>
        <div class="py-5 text-transparent">.</div>
        <div id="control-button-space"></div>
    </div>

    <div id="infoModal" class="modal fade" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-5">
                <div class="modal-body">
                    <div class="table-responsives">
                        <table class="table table-borderless bg-transparent align-middle mb-0">
                            <thead>
                                <tr>
                                    <th scope="col" class="text-muted fw-semibold font-size-14">สถานะ</th>
                                    <th scope="col" class="text-muted fw-semibold font-size-14">คำอธิบาย</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <span
                                            class="badge bg-gradient-allissue text-white font-size-14 fw-normal w-100 rounded-pill"><i
                                                class="fa-solid fa-clipboard-list me-2"></i>เรื่องทั้งหมด</span>
                                    </td>
                                    <td class="font-size-14 text-muted">หมายถึง
                                        จำนวนเรื่องแจ้งปัญหาทั้งหมดที่ถูกบันทึกในระบบ</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span
                                            class="badge bg-gradient-process text-dark font-size-14 fw-normal w-100 rounded-pill"><i
                                                class="fa-solid fa-hammer-brush me-2"></i>ดำเนินการ</span>
                                    </td>
                                    <td class="font-size-14 text-muted">หมายถึง
                                        จำนวนเรื่องแจ้งปัญหาที่อยู่ในระหว่างการดำเนินการแก้ไขหรือจัดการ</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span
                                            class="badge bg-gradient-success text-white font-size-14 fw-normal w-100 rounded-pill"><i
                                                class="fa-solid fa-thumbs-up me-2"></i>เสร็จสิ้น</span>
                                    </td>
                                    <td class="font-size-14 text-muted">หมายถึง
                                        จำนวนเรื่องแจ้งปัญหาที่ได้รับการแก้ไขหรือจัดการเรียบร้อยแล้ว</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span
                                            class="badge bg-gradient-cencel text-white font-size-14 fw-normal w-100 rounded-pill"><i
                                                class="fa-solid fa-ban me-2"></i>ยกเลิก</span>
                                    </td>
                                    <td class="font-size-14 text-muted">หมายถึง
                                        จำนวนเรื่องแจ้งปัญหาที่ถูกยกเลิกหรือไม่ดำเนินการต่อ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cancelReportModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 rounded-5">
                <div class="modal-body px-4 text-center">
                    <h1 class="mb-0 text-warning"><i class="fa-solid fa-triangle-exclamation fa-xl"></i></h1>
                    <h6 class="mt-4 fw-normal text-danger font-size-14">คุณแน่ใจหรือไม่ว่าต้องการยกเลิกรายการนี้?</h6>
                </div>
                <div class="modal-footer d-flex flex-nowrap p-0" style="border-color:#dee2e6">
                    <button type="button"
                        class="btn btn-lg btn-link text-decoration-none font-size-14 col-6 py-3 m-0 rounded-0 border-end"
                        id="cancelReportConfirmBtn">ยืนยัน</button>
                    <button type="button"
                        class="btn btn-lg btn-link text-decoration-none font-size-14 col-6 py-3 m-0 rounded-0"
                        data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editReportModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-5">
                <div class="modal-body px-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div></div>
                        <h5 class="modal-title fs-6 text-dark-info">แก้ไขข้อมูลการปัญหา</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="font-size-14">
                        <div class="position-relative mb-3">
                            <label for="issueTopicEdit" class="form-label">หัวข้อปัญหา</label>
                            <input type="text" class="form-control rounded-pill font-size-14 form-padding"
                                id="issueTopicEdit" placeholder="กรอกหัวข้อปัญหา" required>
                            <i class="fa-solid fa-mailbox form-icon"></i>
                        </div>

                        <div class="position-relative mb-3">
                            <label for="issueDetailEdit" class="form-label">รายละเอียดปัญหา</label>
                            <textarea class="form-control rounded-4 font-size-14 form-padding" id="issueDetailEdit"
                                placeholder="กรอกข้อมูลพอสังเขป" rows="4" required></textarea>
                            <i class="fa-solid fa-file-signature form-icon" style="top: 35%;"></i>
                        </div>

                        <div class="position-relative mb-3">
                            <label for="issueTypeEdit" class="form-label">ประเภทปัญหา</label>
                            <select class="form-select rounded-pill font-size-14 form-padding" id="issueTypeEdit"
                                required>
                                <option value="" disabled selected>เลือกประเภทปัญหา</option>
                                <option value="infrastructure">ปัญหาโครงสร้างพื้นฐาน</option>
                                <option value="facilities">ปัญหาอุปกรณ์และสิ่งอำนวยความสะดวก</option>
                                <option value="safety">ปัญหาด้านความปลอดภัย</option>
                                <option value="cleanliness">ปัญหาด้านความสะอาด</option>
                                <option value="other">อื่นๆ</option>
                            </select>
                            <i class="fa-solid fa-inbox-full form-icon"></i>
                        </div>

                        <div class="position-relative mb-3">
                            <label for="issuePositionEdit" class="form-label">พิกัดที่เกิดปัญหา</label>
                            <div class="row gx-2">
                                <div class="col">
                                    <input type="text" class="form-control rounded-pill font-size-14 form-padding"
                                        id="issuePositionEdit" placeholder="ระบุพิกัดที่เกิดปัญหาโดยใช้ GPS จากมือถือ"
                                        required>
                                </div>
                                <div class="col-auto d-flex align-items-center">
                                    <i class="fa-solid fa-magnifying-glass fa-xl" onclick="getLocationEditMaps()"
                                        role="button"></i>
                                </div>
                            </div>
                            <i class="fa-solid fa-location-crosshairs form-icon"></i>
                        </div>

                        <div class="position-relative mb-3">
                            <label for="issueDetailmoreEdit" class="form-label">รายละเอียดสถานที่เพิ่มเติม
                                (ถ้ามี)</label>
                            <textarea class="form-control rounded-4 font-size-14 form-padding" id="issueDetailmoreEdit"
                                placeholder="ระบุข้อมูลเพิ่มเกี่ยวกับสถานที่ที่พบปัญหา" rows="2" required></textarea>
                            <i class="fa-solid fa-landmark-dome form-icon" style="top: 55%;"></i>
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-flex flex-nowrap p-0" style="border-color:#dee2e6">
                    <button type="button"
                        class="btn btn-lg btn-link text-decoration-none font-size-14 col-6 py-3 m-0 rounded-0 border-end"
                        id="editReportConfirmBtn">ยืนยัน</button>
                    <button type="button"
                        class="btn btn-lg btn-link text-decoration-none font-size-14 col-6 py-3 m-0 rounded-0"
                        data-bs-dismiss="modal">ยกเลิก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ToastAlert -->
    <div aria-live="polite" aria-atomic="true" class="position-relative">
        <div id="toast-container" class="toast-container position-fixed"></div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="mapPositionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
        data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-transparent border-0 shadow-none">
                <div class="modal-body text-center">
                    <div id="map" class="overflow-hidden rounded-4"
                        style="width: 100%; height: 400px; border-radius: 15px;"></div>

                    <div class="mt-3 d-flex flex-column justify-content-center gap-2">
                        <!-- ปุ่มใช้ตำแหน่งปัจจุบัน -->
                        <button type="button" class="btn btn-sm btn-primary rounded-pill px-4 py-1 font-size-14"
                            onclick="useCurrentLocation()">
                            <i class="fa-solid fa-location-crosshairs"></i> ใช้ตำแหน่งปัจจุบัน
                        </button>

                        <!-- ปุ่มปิด -->
                        <button type="button" class="btn btn-sm btn-secondary rounded-pill px-4 py-1 font-size-14"
                            data-bs-dismiss="modal"><i class="fa-solid fa-xmark"></i> ปิด</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loader -->
    <script>
        fetch('loader.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('loader-container').innerHTML = html;
                // รอ 3 วินาทีแล้วซ่อน loader และแสดง main-container
                setTimeout(() => {
                    document.getElementById('loader-container').style.display = 'none';
                    document.querySelector('.main-container').style.display = '';
                }, 1500);
            });
            
        let map; // เก็บตัวแปร map ไว้ด้านนอก

        const getLocationMaps = () => {
            if (!map) {
                map = new longdo.Map({
                    placeholder: document.getElementById("map"),
                    zoom: 14,
                    location: { lon: 99.85877102372518, lat: 16.0579615298894 },
                    ui: longdo.UiComponent.None,
                });
            }

            // Event: ทุกครั้งที่แผนที่เลื่อน
            map.Event.bind('location', () => {
                const location = map.location();
                document.getElementById("issuePositionEdit").value =
                    location.lat.toFixed(9) + ", " + location.lon.toFixed(9);
            }); 
        };

        // ใช้ตำแหน่งจริงจาก GPS
        const useCurrentLocation = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;

                    // เซ็ตศูนย์กลางใหม่
                    map.location({ lat, lon }, true);

                    // อัปเดตค่า input
                    document.getElementById("issuePositionEdit").value =
                        lat.toFixed(9) + ", " + lon.toFixed(9);
                }, (err) => {
                    alert("ไม่สามารถดึงตำแหน่งได้: " + err.message);
                });
            } else {
                alert("เบราว์เซอร์ไม่รองรับการหาตำแหน่ง");
            }
        };

        const getLocationEditMaps = () => {
            getLocationMaps();
            const modalEl = document.getElementById("mapPositionModal");
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    </script>

    <!-- // api-longdo-map -->
    <script src="https://api.longdo.com/map/?key=dc0e4b019d46832d6245ff133fba6877"></script>
    <!-- LoadIcon -->
    <script src="https://cdn.lordicon.com/lordicon.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- CDN liff -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- CDN JQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap 5.3 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <!-- โหลด pageConfig.js ก่อน -->
    <script src="script/pageConfig.js"></script>
    <!-- โหลด userDataManager.js -->
    <script src="script/userDataManager.js"></script>
    <!-- โหลด script.js -->
    <script src="script/script.js"></script>
    <!-- โหลด control-button.js -->
    <script src="script/control-button.js"></script>
    <!-- โหลด filebase.js ทีหลัง -->
    <script src="script/filebase.js"></script>
    <!-- โหลด tracking.js ทีหลัง -->
    <script src="script/tracking.js"></script>

</body>

</html>